var M=Object.defineProperty;var v=n=>{throw TypeError(n)};var A=(n,e,t)=>e in n?M(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var k=(n,e,t)=>A(n,typeof e!="symbol"?e+"":e,t),f=(n,e,t)=>e.has(n)||v("Cannot "+t);var a=(n,e,t)=>(f(n,e,"read from private field"),t?t.call(n):e.get(n)),g=(n,e,t)=>e.has(n)?v("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),p=(n,e,t,i)=>(f(n,e,"write to private field"),i?i.call(n,t):e.set(n,t),t),S=(n,e,t)=>(f(n,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function t(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=t(o);fetch(o.href,r)}})();const b={BASE_URL:"https://story-api.dicoding.dev/v1"};async function D(n,e,t){const i=await fetch(`${b.BASE_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,email:e,password:t})}),o=await i.json();if(!i.ok)throw new Error(o.message);return o}async function R(n,e){const t=await fetch(`${b.BASE_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,password:e})}),i=await t.json();if(!t.ok)throw new Error(i.message);const{token:o,name:r}=i.loginResult;return localStorage.setItem("token",o),localStorage.setItem("name",r),i}async function x(){const n=localStorage.getItem("token");if(!n)throw new Error("User belum login");const e=await fetch(`${b.BASE_URL}/stories`,{headers:{Authorization:`Bearer ${n}`}});if(!e.ok){const i=await e.json();throw new Error(i.message||"Gagal ambil data cerita")}return(await e.json()).listStory}async function H({description:n,photoFile:e,lat:t=null,lon:i=null,token:o}){if(!o)throw new Error("Token auth wajib ada");const r=new FormData;r.append("description",n),r.append("photo",e),t!==null&&r.append("lat",t),i!==null&&r.append("lon",i);const s=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${o}`},body:r}),c=await s.json();if(!s.ok||c.error)throw new Error(c.message||"Gagal tambah story");return c}const O="story-app-db",d="stories",j=1;class w{static openDB(){return this.dbPromise||(this.dbPromise=new Promise((e,t)=>{const i=indexedDB.open(O,j);i.onupgradeneeded=o=>{const r=o.target.result;r.objectStoreNames.contains(d)||r.createObjectStore(d,{keyPath:"id"})},i.onsuccess=()=>e(i.result),i.onerror=()=>t(i.error)})),this.dbPromise}static async saveStories(e){if(!Array.isArray(e))throw new TypeError("Data stories harus berupa array");const i=(await this.openDB()).transaction(d,"readwrite"),o=i.objectStore(d);return e.forEach(r=>o.put(r)),i.complete||new Promise((r,s)=>{i.oncomplete=()=>r(),i.onerror=()=>s(i.error)})}static async getAllStories(){const e=await this.openDB();return new Promise((t,i)=>{const s=e.transaction(d,"readonly").objectStore(d).getAll();s.onsuccess=()=>t(s.result),s.onerror=()=>i(s.error)})}static async clearStories(){const t=(await this.openDB()).transaction(d,"readwrite");return t.objectStore(d).clear(),t.complete||new Promise((i,o)=>{t.oncomplete=()=>i(),t.onerror=()=>o(t.error)})}}k(w,"dbPromise",null);const N={async getAllStories(){try{const n=await x();return await w.clearStories(),await w.saveStories(n),n}catch(n){return console.warn("Gagal fetch API, ambil dari cache:",n.message),await w.getAllStories()||[]}}};class q{getTemplate(){return`
        <section tabindex="0">
          <h1>Home</h1>
          <p>Selamat datang di aplikasi Story API kami!</p>
          <ul id="story-list" aria-live="polite">
            <li>Loading stories...</li>
          </ul>
          <div id="map" style="height: 400px; width: 100%; margin-top: 1rem;"></div>
        </section>
      `}showStories(e){const t=document.getElementById("story-list");if(t.innerHTML="",!e||e.length===0){t.innerHTML="<li>Tidak ada cerita tersedia.</li>";return}e.forEach(i=>{const o=document.createElement("li");o.innerHTML=`
          <article tabindex="0" aria-label="Cerita dari ${i.name}">
            <img src="${i.photoUrl}" alt="Gambar ${i.name}" width="200" height="140"/>
            <h2>${i.name}</h2>
            <p><strong>Deskripsi:</strong> ${i.description||"-"}</p>
            <p><strong>Lokasi:</strong> ${i.lat??"-"}, ${i.lon??"-"}</p>
          </article>
        `,t.appendChild(o)})}showMapWithMarkers(e){const t=L.map("map").setView([-2.5489,118.0149],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(t),e.forEach(i=>{i.lat&&i.lon&&L.marker([i.lat,i.lon]).addTo(t).bindPopup(`<b>${i.name}</b><br>${i.description||"-"}`)})}showError(e){const t=document.getElementById("story-list");t.innerHTML=`<li>Error: ${e}</li>`}}class C{constructor(e,t){this.view=e,this.model=t}async init(e){e.innerHTML=this.view.getTemplate();try{const t=await this.model.getAllStories();this.view.showStories(t),this.view.showMapWithMarkers(t)}catch(t){this.view.showError(t.message)}}}class F{constructor(){this.view=new q,this.model=N,this.presenter=new C(this.view,this.model)}async render(){return document.createElement("section")}async afterRender(){const e=document.querySelector("section");await this.presenter.init(e)}}class P{static loginTemplate(){return`
      <section tabindex="0">
        <h1>Login</h1>
        <form id="login-form">
          <label for="email">Email:</label><br>
          <input type="email" id="email" name="email" required><br><br>

          <label for="password">Password:</label><br>
          <input type="password" id="password" name="password" required><br><br>

          <button type="submit">Login</button>
        </form>
        <p>Belum punya akun? <a href="#/register" id="to-register">Register di sini</a></p>
      </section>
    `}static registerTemplate(){return`
      <section tabindex="0">
        <h1>Register</h1>
        <form id="register-form">
          <label for="name">Nama:</label><br>
          <input type="text" id="name" name="name" required><br><br>

          <label for="email">Email:</label><br>
          <input type="email" id="email" name="email" required><br><br>

          <label for="password">Password:</label><br>
          <input type="password" id="password" name="password" required minlength="8"><br><br>

          <button type="submit">Register</button>
        </form>
        <p>Sudah punya akun? <a href="#/login" id="to-login">Login di sini</a></p>
      </section>
    `}}const B={initLogin(n){document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();try{const t=document.getElementById("email").value,i=document.getElementById("password").value,o=await n.login(t,i);localStorage.setItem("token",o.loginResult.token),localStorage.setItem("name",o.loginResult.name),alert(`Login sukses! Halo, ${o.loginResult.name}`),window.location.href="#/"}catch(t){alert("Login gagal: "+t.message)}})},initRegister(n){document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();try{const t=document.getElementById("name").value,i=document.getElementById("email").value,o=document.getElementById("password").value,r=await n.register(t,i,o);alert("Register sukses! Silakan login."),window.location.href="#/login"}catch(t){alert("Register gagal: "+t.message)}})}},T={async login(n,e){return await R(n,e)},async register(n,e,t){return await D(n,e,t)}};class ${async render(){const e=document.createElement("section");return e.innerHTML=P.loginTemplate(),e}async afterRender(){B.initLogin(T)}}class U{async render(){const e=document.createElement("section");return e.innerHTML=P.registerTemplate(),e}async afterRender(){B.initRegister(T)}}const V={async saveStory({description:n,photoFile:e,lat:t,lon:i,token:o}){return await H({description:n,photoFile:e,lat:t,lon:i,token:o})}};class _{constructor(){this.lat=null,this.lon=null,this.videoStream=null}getTemplate(){return`
      <section tabindex="0">
        <h1>Tambah Story Baru</h1>
        <form id="story-form">
          <label>Deskripsi:<br>
            <textarea id="description" required rows="3" cols="30"></textarea>
          </label><br><br>

          <div>
            <button type="button" id="start-camera">Mulai Kamera</button>
            <button type="button" id="take-photo" disabled>Ambil Foto</button>
            <video id="video" width="300" height="200" autoplay style="display:none;"></video>
            <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
          </div><br>

          <div id="map" style="height: 300px; width: 100%;"></div><br>

          <button type="submit">Kirim Story</button>
        </form>
        <div id="message" role="alert" aria-live="assertive"></div>
      </section>
    `}bindEvents({onSubmit:e,onStartCamera:t,onTakePhoto:i,onUploadPhoto:o}){if(document.getElementById("story-form").addEventListener("submit",e),document.getElementById("start-camera").addEventListener("click",t),document.getElementById("take-photo").addEventListener("click",i),o){const s=document.getElementById("upload-photo");s&&s.addEventListener("change",c=>{const h=c.target.files[0];h&&o(h)})}}showMessage(e,t=!1){const i=document.getElementById("message");i.textContent=e,i.style.color=t?"red":"green"}startVideoStream(e){this.videoStream=e;const t=document.getElementById("video");t.srcObject=e,t.style.display="block",document.getElementById("take-photo").disabled=!1}stopVideoStream(){this.videoStream&&(this.videoStream.getTracks().forEach(t=>t.stop()),this.videoStream=null);const e=document.getElementById("video");e.style.display="none"}async takePhoto(){const e=document.getElementById("video"),t=document.getElementById("canvas");return t.style.display="block",t.getContext("2d").drawImage(e,0,0,t.width,t.height),new Promise(o=>{t.toBlob(r=>{o(new File([r],"photo.jpg",{type:"image/jpeg"}))},"image/jpeg",.9)})}setLocation(e,t){this.lat=e,this.lon=t}getDescription(){var e;return(e=document.getElementById("description"))==null?void 0:e.value.trim()}resetForm(){var e;(e=document.getElementById("story-form"))==null||e.reset(),document.getElementById("canvas").style.display="none",document.getElementById("video").style.display="none",document.getElementById("take-photo").disabled=!0}redirectToHome(){window.location.hash="#/"}}class G{constructor(e,t,i){this.model=t,this.view=i,this.container=e,this.photoFile=null}async init(){this.container.innerHTML=this.view.getTemplate(),this.view.bindEvents({onSubmit:this.handleSubmit.bind(this),onStartCamera:this.handleStartCamera.bind(this),onTakePhoto:this.handleTakePhoto.bind(this),onUploadPhoto:this.handleUploadPhoto.bind(this)}),this.initMap()}destroy(){this.view.stopVideoStream()}async handleStartCamera(){try{const e=await navigator.mediaDevices.getUserMedia({video:!0});this.view.startVideoStream(e)}catch(e){this.view.showMessage("Tidak bisa akses kamera: "+e.message,!0)}}async handleTakePhoto(e){e&&e.preventDefault(),this.photoFile=await this.view.takePhoto(),this.view.stopVideoStream(),this.view.showMessage("Foto berhasil diambil, silakan tekan tombol submit untuk mengirim.")}async handleUploadPhoto(e){this.photoFile=e,this.view.showMessage("Foto berhasil diupload, siap dikirim.")}initMap(){const e=L.map("map").setView([-2.5489,118.0149],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e);const t=L.marker([-2.5489,118.0149],{draggable:!0}).addTo(e);t.on("dragend",()=>{const i=t.getLatLng();this.view.setLocation(i.lat,i.lng)}),e.on("click",i=>{t.setLatLng(i.latlng),this.view.setLocation(i.latlng.lat,i.latlng.lng)}),this.view.setLocation(-2.5489,118.0149)}async handleSubmit(e){e.preventDefault(),await this.submitStory()}async submitStory(){const e=localStorage.getItem("token");if(!e){this.view.showMessage("User belum login",!0);return}const t=this.view.getDescription();if(!t){this.view.showMessage("Deskripsi wajib diisi",!0);return}if(!this.photoFile){this.view.showMessage("Foto wajib diambil atau diupload",!0);return}this.view.showMessage("Mengirim story...");try{await this.model.saveStory({description:t,photoFile:this.photoFile,lat:this.view.lat,lon:this.view.lon,token:e}),this.view.showMessage("Story berhasil ditambahkan"),this.view.resetForm(),this.photoFile=null,this.view.setLocation(-2.5489,118.0149),this.view.redirectToHome()}catch(i){this.view.showMessage(i.message,!0)}}}class W{constructor(){this.view=new _,this.presenter=null}async render(){const e=document.createElement("section");return e.innerHTML=this.view.getTemplate(),e}async afterRender(){const e=document.querySelector("section");this.presenter=new G(e,V,this.view),await this.presenter.init()}async beforeRender(){this.presenter&&this.presenter.destroy()}}const z={"/":new F,"/login":new $,"/register":new U,"/add-story":new W};function K(n){const e=n.split("/");return{resource:e[1]||null,id:e[2]||null}}function J(n){let e="";return n.resource&&(e=e.concat(`/${n.resource}`)),n.id&&(e=e.concat("/:id")),e||"/"}function Q(){return location.hash.replace("#","")||"/"}function Y(){const n=Q(),e=K(n);return J(e)}var u,m,l,y,I;class X{constructor({navigationDrawer:e,drawerButton:t,content:i}){g(this,y);g(this,u,null);g(this,m,null);g(this,l,null);p(this,u,i),p(this,m,t),p(this,l,e),S(this,y,I).call(this)}async renderNav(){const e=localStorage.getItem("token");let t=`
      <ul id="nav-list" class="nav-list">
        <li><a href="#/">Beranda</a></li>
        <li><a href="#/add-story">Add Story</a></li>
    `;e?t+='<li><a href="#" id="login-logout-link">Logout</a></li>':t+='<li><a href="#/login" id="login-logout-link">Login</a></li>',t+="</ul>",a(this,l).innerHTML=t,e&&document.getElementById("login-logout-link").addEventListener("click",o=>{o.preventDefault(),localStorage.removeItem("token"),alert("Berhasil logout!"),this.renderNav(),window.location.hash="#/login"})}async renderPage(){await this.renderNav();const e=localStorage.getItem("token"),t=Y();if(!e&&t!=="/login"&&t!=="/register"){window.location.hash="#/login";return}const i=z[t];if(!i){a(this,u).innerHTML="<p>Halaman tidak ditemukan.</p>";return}const o=async()=>{a(this,u).innerHTML="";const r=await i.render();a(this,u).appendChild(r),await i.afterRender()};document.startViewTransition?document.startViewTransition(()=>o()):await o()}}u=new WeakMap,m=new WeakMap,l=new WeakMap,y=new WeakSet,I=function(){a(this,m).addEventListener("click",()=>{a(this,l).classList.toggle("open")}),document.body.addEventListener("click",e=>{!a(this,l).contains(e.target)&&!a(this,m).contains(e.target)&&a(this,l).classList.remove("open"),a(this,l).querySelectorAll("a").forEach(t=>{t.contains(e.target)&&a(this,l).classList.remove("open")})})};const E={vapidPublicKey:"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk",async requestPermission(){if(await Notification.requestPermission()!=="granted")throw new Error("Izin notifikasi tidak diberikan.")},async subscribeToPush(){const n=await navigator.serviceWorker.ready,e=this._urlBase64ToUint8Array(this.vapidPublicKey),t=await n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e}),i=localStorage.getItem("token");if(!i)throw new Error("Token tidak ditemukan!");const{endpoint:o,keys:r}=t.toJSON(),s={endpoint:o,keys:{p256dh:r.p256dh,auth:r.auth}};console.log("Payload ke /notifications/subscribe:",s);const c=await fetch(`${b.BASE_URL}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(s)});if(!c.ok){const h=await c.json();throw console.error("Gagal subscribe:",h),new Error(h.message||"Gagal subscribe push notification")}return t},_urlBase64ToUint8Array(n){const e="=".repeat((4-n.length%4)%4),t=(n+e).replace(/-/g,"+").replace(/_/g,"/"),i=atob(t),o=new Uint8Array(i.length);for(let r=0;r<i.length;++r)o[r]=i.charCodeAt(r);return o}},Z={initInstallPrompt(){let n;const e=document.getElementById("installBtn");if(!e){console.warn("Install button (#installBtn) not found!");return}window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),n=t,e.style.display="block",e.addEventListener("click",async()=>{e.style.display="none",n.prompt();const{outcome:i}=await n.userChoice;console.log("User response to install prompt:",i)})})}};async function ee(){if("serviceWorker"in navigator)try{const n=await navigator.serviceWorker.register("/sw.js");console.log("Service Worker registered:",n),"PushManager"in window?(await E.requestPermission(),await E.subscribeToPush(),console.log("Push Notification aktif!")):console.log("Browser tidak mendukung PushManager")}catch(n){console.error("Gagal mengaktifkan Service Worker atau Push Notification:",n.message)}else console.warn("Service Worker tidak didukung di browser ini.")}document.addEventListener("DOMContentLoaded",async()=>{const n=new X({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});await n.renderPage(),window.addEventListener("hashchange",async()=>{await n.renderPage()}),Z.initInstallPrompt();const e=document.querySelector(".skip-link"),t=document.getElementById("main-content");e&&t&&e.addEventListener("click",i=>{i.preventDefault(),e.blur(),t.setAttribute("tabindex","-1"),t.focus(),t.scrollIntoView({behavior:"smooth"})}),await ee()});
