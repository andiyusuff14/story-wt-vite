var A=Object.defineProperty;var v=i=>{throw TypeError(i)};var D=(i,e,t)=>e in i?A(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var k=(i,e,t)=>D(i,typeof e!="symbol"?e+"":e,t),f=(i,e,t)=>e.has(i)||v("Cannot "+t);var s=(i,e,t)=>(f(i,e,"read from private field"),t?t.call(i):e.get(i)),g=(i,e,t)=>e.has(i)?v("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),p=(i,e,t,o)=>(f(i,e,"write to private field"),o?o.call(i,t):e.set(i,t),t),S=(i,e,t)=>(f(i,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();const b={BASE_URL:"https://story-api.dicoding.dev/v1"};async function R(i,e,t){const o=await fetch(`${b.BASE_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i,email:e,password:t})}),r=await o.json();if(!o.ok)throw new Error(r.message);return r}async function H(i,e){const t=await fetch(`${b.BASE_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i,password:e})}),o=await t.json();if(!t.ok)throw new Error(o.message);const{token:r,name:n}=o.loginResult;return localStorage.setItem("token",r),localStorage.setItem("name",n),o}async function x(){const i=localStorage.getItem("token");if(!i)throw new Error("User belum login");const e=await fetch(`${b.BASE_URL}/stories`,{headers:{Authorization:`Bearer ${i}`}});if(!e.ok){const o=await e.json();throw new Error(o.message||"Gagal ambil data cerita")}return(await e.json()).listStory}async function O({description:i,photoFile:e,lat:t=null,lon:o=null,token:r}){if(!r)throw new Error("Token auth wajib ada");const n=new FormData;n.append("description",i),n.append("photo",e),t!==null&&n.append("lat",t),o!==null&&n.append("lon",o);const a=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${r}`},body:n}),c=await a.json();if(!a.ok||c.error)throw new Error(c.message||"Gagal tambah story");return c}const N="story-app-db",d="stories",j=1;class w{static openDB(){return this.dbPromise||(this.dbPromise=new Promise((e,t)=>{const o=indexedDB.open(N,j);o.onupgradeneeded=r=>{const n=r.target.result;n.objectStoreNames.contains(d)||n.createObjectStore(d,{keyPath:"id"})},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})),this.dbPromise}static async saveStories(e){if(!Array.isArray(e))throw new TypeError("Data stories harus berupa array");const o=(await this.openDB()).transaction(d,"readwrite"),r=o.objectStore(d);return e.forEach(n=>r.put(n)),o.complete||new Promise((n,a)=>{o.oncomplete=()=>n(),o.onerror=()=>a(o.error)})}static async getAllStories(){const e=await this.openDB();return new Promise((t,o)=>{const a=e.transaction(d,"readonly").objectStore(d).getAll();a.onsuccess=()=>t(a.result),a.onerror=()=>o(a.error)})}static async clearStories(){const t=(await this.openDB()).transaction(d,"readwrite");return t.objectStore(d).clear(),t.complete||new Promise((o,r)=>{t.oncomplete=()=>o(),t.onerror=()=>r(t.error)})}}k(w,"dbPromise",null);const $={async getAllStories(){try{const i=await x();return await w.clearStories(),await w.saveStories(i),i}catch(i){return console.warn("Gagal fetch API, ambil dari cache:",i.message),await w.getAllStories()||[]}}};class q{getTemplate(){return`
        <section tabindex="0">
          <h1>Home</h1>
          <p>Selamat datang di aplikasi Story API kami!</p>
          <ul id="story-list" aria-live="polite">
            <li>Loading stories...</li>
          </ul>
          <div id="map" style="height: 400px; width: 100%; margin-top: 1rem;"></div>
        </section>
      `}showStories(e){const t=document.getElementById("story-list");if(t.innerHTML="",!e||e.length===0){t.innerHTML="<li>Tidak ada cerita tersedia.</li>";return}e.forEach(o=>{const r=document.createElement("li");r.innerHTML=`
          <article tabindex="0" aria-label="Cerita dari ${o.name}">
            <img src="${o.photoUrl}" alt="Gambar ${o.name}" width="200" height="140"/>
            <h2>${o.name}</h2>
            <p><strong>Deskripsi:</strong> ${o.description||"-"}</p>
            <p><strong>Lokasi:</strong> ${o.lat??"-"}, ${o.lon??"-"}</p>
          </article>
        `,t.appendChild(r)})}showMapWithMarkers(e){const t=L.map("map").setView([-2.5489,118.0149],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(t),e.forEach(o=>{o.lat&&o.lon&&L.marker([o.lat,o.lon]).addTo(t).bindPopup(`<b>${o.name}</b><br>${o.description||"-"}`)})}showError(e){const t=document.getElementById("story-list");t.innerHTML=`<li>Error: ${e}</li>`}}class C{constructor(e,t){this.view=e,this.model=t}async init(e){e.innerHTML=this.view.getTemplate();try{const t=await this.model.getAllStories();this.view.showStories(t),this.view.showMapWithMarkers(t)}catch(t){this.view.showError(t.message)}}}class F{constructor(){this.view=new q,this.model=$,this.presenter=new C(this.view,this.model)}async render(){return document.createElement("section")}async afterRender(){const e=document.querySelector("section");await this.presenter.init(e)}}class P{static loginTemplate(){return`
      <section tabindex="0">
        <h1>Login</h1>
        <form id="login-form">
          <label for="email">Email:</label><br>
          <input type="email" id="email" name="email" required><br><br>

          <label for="password">Password:</label><br>
          <input type="password" id="password" name="password" required><br><br>

          <button type="submit">Login</button>
        </form>
        <p>Belum punya akun? <a href="#/register" id="to-register">Register di sini</a></p>
      </section>
    `}static registerTemplate(){return`
      <section tabindex="0">
        <h1>Register</h1>
        <form id="register-form">
          <label for="name">Nama:</label><br>
          <input type="text" id="name" name="name" required><br><br>

          <label for="email">Email:</label><br>
          <input type="email" id="email" name="email" required><br><br>

          <label for="password">Password:</label><br>
          <input type="password" id="password" name="password" required minlength="8"><br><br>

          <button type="submit">Register</button>
        </form>
        <p>Sudah punya akun? <a href="#/login" id="to-login">Login di sini</a></p>
      </section>
    `}}const B={initLogin(i){document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();try{const t=document.getElementById("email").value,o=document.getElementById("password").value,r=await i.login(t,o);localStorage.setItem("token",r.loginResult.token),localStorage.setItem("name",r.loginResult.name),alert(`Login sukses! Halo, ${r.loginResult.name}`),window.location.href="#/"}catch(t){alert("Login gagal: "+t.message)}})},initRegister(i){document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();try{const t=document.getElementById("name").value,o=document.getElementById("email").value,r=document.getElementById("password").value,n=await i.register(t,o,r);alert("Register sukses! Silakan login."),window.location.href="#/login"}catch(t){alert("Register gagal: "+t.message)}})}},T={async login(i,e){return await H(i,e)},async register(i,e,t){return await R(i,e,t)}};class U{async render(){const e=document.createElement("section");return e.innerHTML=P.loginTemplate(),e}async afterRender(){B.initLogin(T)}}class V{async render(){const e=document.createElement("section");return e.innerHTML=P.registerTemplate(),e}async afterRender(){B.initRegister(T)}}const _={async saveStory({description:i,photoFile:e,lat:t,lon:o,token:r}){return await O({description:i,photoFile:e,lat:t,lon:o,token:r})}};class W{constructor(){this.lat=null,this.lon=null,this.videoStream=null}getTemplate(){return`
      <section tabindex="0">
        <h1>Tambah Story Baru</h1>
        <form id="story-form">
          <label>Deskripsi:<br>
            <textarea id="description" required rows="3" cols="30"></textarea>
          </label><br><br>

          <div>
            <button type="button" id="start-camera">Mulai Kamera</button>
            <button type="button" id="take-photo" disabled>Ambil Foto</button>
            <video id="video" width="300" height="200" autoplay style="display:none;"></video>
            <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
          </div><br>

          <div id="map" style="height: 300px; width: 100%;"></div><br>

          <button type="submit">Kirim Story</button>
        </form>
        <div id="message" role="alert" aria-live="assertive"></div>
      </section>
    `}bindEvents({onSubmit:e,onStartCamera:t,onTakePhoto:o,onUploadPhoto:r}){if(document.getElementById("story-form").addEventListener("submit",e),document.getElementById("start-camera").addEventListener("click",t),document.getElementById("take-photo").addEventListener("click",o),r){const a=document.getElementById("upload-photo");a&&a.addEventListener("change",c=>{const u=c.target.files[0];u&&r(u)})}}showMessage(e,t=!1){const o=document.getElementById("message");o.textContent=e,o.style.color=t?"red":"green"}startVideoStream(e){this.videoStream=e;const t=document.getElementById("video");t.srcObject=e,t.style.display="block",document.getElementById("take-photo").disabled=!1}stopVideoStream(){this.videoStream&&(this.videoStream.getTracks().forEach(t=>t.stop()),this.videoStream=null);const e=document.getElementById("video");e.style.display="none"}async takePhoto(){const e=document.getElementById("video"),t=document.getElementById("canvas");return t.style.display="block",t.getContext("2d").drawImage(e,0,0,t.width,t.height),new Promise(r=>{t.toBlob(n=>{r(new File([n],"photo.jpg",{type:"image/jpeg"}))},"image/jpeg",.9)})}setLocation(e,t){this.lat=e,this.lon=t}getDescription(){var e;return(e=document.getElementById("description"))==null?void 0:e.value.trim()}resetForm(){var e;(e=document.getElementById("story-form"))==null||e.reset(),document.getElementById("canvas").style.display="none",document.getElementById("video").style.display="none",document.getElementById("take-photo").disabled=!0}redirectToHome(){window.location.hash="#/"}}class G{constructor(e,t,o){this.model=t,this.view=o,this.container=e,this.photoFile=null}async init(){this.container.innerHTML=this.view.getTemplate(),this.view.bindEvents({onSubmit:this.handleSubmit.bind(this),onStartCamera:this.handleStartCamera.bind(this),onTakePhoto:this.handleTakePhoto.bind(this),onUploadPhoto:this.handleUploadPhoto.bind(this)}),this.initMap()}destroy(){this.view.stopVideoStream()}async handleStartCamera(){try{const e=await navigator.mediaDevices.getUserMedia({video:!0});this.view.startVideoStream(e)}catch(e){this.view.showMessage("Tidak bisa akses kamera: "+e.message,!0)}}async handleTakePhoto(e){e&&e.preventDefault(),this.photoFile=await this.view.takePhoto(),this.view.stopVideoStream(),this.view.showMessage("Foto berhasil diambil, silakan tekan tombol submit untuk mengirim.")}async handleUploadPhoto(e){this.photoFile=e,this.view.showMessage("Foto berhasil diupload, siap dikirim.")}initMap(){const e=L.map("map").setView([-2.5489,118.0149],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e);const t=L.marker([-2.5489,118.0149],{draggable:!0}).addTo(e);t.on("dragend",()=>{const o=t.getLatLng();this.view.setLocation(o.lat,o.lng)}),e.on("click",o=>{t.setLatLng(o.latlng),this.view.setLocation(o.latlng.lat,o.latlng.lng)}),this.view.setLocation(-2.5489,118.0149)}async handleSubmit(e){e.preventDefault(),await this.submitStory()}async submitStory(){const e=localStorage.getItem("token");if(!e){this.view.showMessage("User belum login",!0);return}const t=this.view.getDescription();if(!t){this.view.showMessage("Deskripsi wajib diisi",!0);return}if(!this.photoFile){this.view.showMessage("Foto wajib diambil atau diupload",!0);return}this.view.showMessage("Mengirim story...");try{await this.model.saveStory({description:t,photoFile:this.photoFile,lat:this.view.lat,lon:this.view.lon,token:e}),this.view.showMessage("Story berhasil ditambahkan"),this.view.resetForm(),this.photoFile=null,this.view.setLocation(-2.5489,118.0149),this.view.redirectToHome()}catch(o){this.view.showMessage(o.message,!0)}}}class z{constructor(){this.view=new W,this.presenter=null}async render(){const e=document.createElement("section");return e.innerHTML=this.view.getTemplate(),e}async afterRender(){const e=document.querySelector("section");this.presenter=new G(e,_,this.view),await this.presenter.init()}async beforeRender(){this.presenter&&this.presenter.destroy()}}const K={"/":new F,"/login":new U,"/register":new V,"/add-story":new z};function J(i){const e=i.split("/");return{resource:e[1]||null,id:e[2]||null}}function Q(i){let e="";return i.resource&&(e=e.concat(`/${i.resource}`)),i.id&&(e=e.concat("/:id")),e||"/"}function Y(){return location.hash.replace("#","")||"/"}function X(){const i=Y(),e=J(i);return Q(e)}var m,h,l,y,I;class Z{constructor({navigationDrawer:e,drawerButton:t,content:o}){g(this,y);g(this,m,null);g(this,h,null);g(this,l,null);p(this,m,o),p(this,h,t),p(this,l,e),S(this,y,I).call(this)}async renderNav(){const e=localStorage.getItem("token");let t=`
      <ul id="nav-list" class="nav-list">
        <li><a href="#/">Beranda</a></li>
        <li><a href="#/add-story">Add Story</a></li>
    `;e?t+='<li><a href="#" id="login-logout-link">Logout</a></li>':t+='<li><a href="#/login" id="login-logout-link">Login</a></li>',t+="</ul>",s(this,l).innerHTML=t,e&&document.getElementById("login-logout-link").addEventListener("click",r=>{r.preventDefault(),localStorage.removeItem("token"),alert("Berhasil logout!"),this.renderNav(),window.location.hash="#/login"})}async renderPage(){await this.renderNav();const e=localStorage.getItem("token"),t=X();if(!e&&t!=="/login"&&t!=="/register"){window.location.hash="#/login";return}const o=K[t];if(!o){s(this,m).innerHTML="<p>Halaman tidak ditemukan.</p>";return}const r=async()=>{s(this,m).innerHTML="";const n=await o.render();s(this,m).appendChild(n),await o.afterRender()};document.startViewTransition?document.startViewTransition(()=>r()):await r()}}m=new WeakMap,h=new WeakMap,l=new WeakMap,y=new WeakSet,I=function(){s(this,h).addEventListener("click",()=>{s(this,l).classList.toggle("open")}),document.body.addEventListener("click",e=>{!s(this,l).contains(e.target)&&!s(this,h).contains(e.target)&&s(this,l).classList.remove("open"),s(this,l).querySelectorAll("a").forEach(t=>{t.contains(e.target)&&s(this,l).classList.remove("open")})})};const E={vapidPublicKey:"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk",async requestPermission(){const i=await Notification.requestPermission();if(console.log("🟡 Status permission:",i),i!=="granted")throw new Error("Izin notifikasi tidak diberikan oleh user.")},async subscribeToPush(){const i=await navigator.serviceWorker.ready;console.log("🟢 Service Worker siap:",i);const e=this._urlBase64ToUint8Array(this.vapidPublicKey);let t=await i.pushManager.getSubscription();t?console.log("ℹ️ Sudah terdaftar push subscription:",t):(t=await i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e}),console.log("📬 Berhasil subscribe push:",t));const o=localStorage.getItem("token");if(!o)throw new Error("Token pengguna tidak ditemukan di localStorage.");const{endpoint:r,keys:n}=t.toJSON(),a={endpoint:r,keys:{p256dh:n.p256dh,auth:n.auth}};console.log("📦 Mengirim payload ke backend:",a);const c=await fetch(`${b.BASE_URL}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(a)});if(!c.ok){let u=`HTTP ${c.status}`;try{u=(await c.json()).message||u}catch{}throw console.error("❌ Gagal subscribe ke server:",u),new Error(u)}return console.log("✅ Push subscription berhasil dikirim ke server"),t},_urlBase64ToUint8Array(i){const e="=".repeat((4-i.length%4)%4),t=(i+e).replace(/-/g,"+").replace(/_/g,"/"),o=atob(t),r=new Uint8Array(o.length);for(let n=0;n<o.length;++n)r[n]=o.charCodeAt(n);return r}},ee={initInstallPrompt(){let i;const e=document.getElementById("installBtn");if(!e){console.warn("Install button (#installBtn) not found!");return}window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),i=t,e.style.display="block",e.addEventListener("click",async()=>{e.style.display="none",i.prompt();const{outcome:o}=await i.userChoice;console.log("User response to install prompt:",o)})})}};async function te(){if(!("serviceWorker"in navigator))return console.warn("⚠️ Service Worker tidak didukung di browser ini."),null;try{const i=await navigator.serviceWorker.register("/story-wt-vite/sw.js");return console.log("✅ Service Worker terdaftar:",i),i}catch(i){return console.error("❌ Gagal mendaftarkan Service Worker:",i.message),null}}async function ie(i){if(!i){console.warn("⚠️ Push Notification dilewati karena Service Worker gagal.");return}if(!("PushManager"in window)){console.warn("⚠️ Browser tidak mendukung PushManager.");return}try{await E.requestPermission(),await E.subscribeToPush(),console.log("✅ Push Notification aktif!")}catch(e){console.error("❌ Gagal mengaktifkan Push Notification:",e.message)}}document.addEventListener("DOMContentLoaded",async()=>{console.log("🚀 DOM ready, mulai inisialisasi...");try{const i=new Z({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});await i.renderPage(),window.addEventListener("hashchange",async()=>{await i.renderPage()}),ee.initInstallPrompt();const e=document.querySelector(".skip-link"),t=document.getElementById("main-content");e&&t&&e.addEventListener("click",r=>{r.preventDefault(),e.blur(),t.setAttribute("tabindex","-1"),t.focus(),t.scrollIntoView({behavior:"smooth"})});const o=await te();await ie(o)}catch(i){console.error("❌ Error saat inisialisasi aplikasi:",i)}});
